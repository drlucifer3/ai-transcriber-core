<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Transcriber Core</title>
    <link
        href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
</head>

<body>
    <div class="container">
        <header>
            <h1>AI Transcriber Core</h1>
            <div class="subtitle">SISTEMA DE TRANSCRIPCI√ìN Y AN√ÅLISIS DE VIDEO</div>
        </header>

        <!-- Upload Section -->
        <div class="card" id="uploadCard">
            <div class="drop-zone" id="dropZone">
                <div class="icon">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>
                </div>
                <h3>ARRASTRAR ARCHIVO MP4 AQU√ç</h3>
                <p>o haga clic para seleccionar</p>
                <input type="file" id="fileInput" accept=".mp4" style="display: none;">
            </div>

            <!-- Options -->
            <div style="display: flex; gap: 20px; margin-top: 20px;">
                <div style="flex: 1;">
                    <label
                        style="display: block; margin-bottom: 5px; color: var(--text-secondary); font-size: 0.8rem;">MODO
                        TRANSCRIPCI√ìN</label>
                    <select id="transcriptionMode"
                        style="width: 100%; padding: 10px; background: rgba(0,0,0,0.3); border: 1px solid #333; color: var(--text-primary); border-radius: 8px;">
                        <option value="local">LOCAL (Whisper Base)</option>
                        <option value="cloud">CLOUD (OpenAI Whisper API)</option>
                    </select>
                </div>
                <div style="flex: 1;">
                    <label
                        style="display: block; margin-bottom: 5px; color: var(--text-secondary); font-size: 0.8rem;">MODELO
                        RESUMEN</label>
                    <select id="summaryModel"
                        style="width: 100%; padding: 10px; background: rgba(0,0,0,0.3); border: 1px solid #333; color: var(--text-primary); border-radius: 8px;">
                        <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                        <option value="gpt-4o">GPT-4o</option>
                    </select>
                </div>
            </div>
            
            <!-- Auto Delete Option -->
            <div style="margin-top: 15px; display: flex; align-items: center; gap: 10px;">
                <input type="checkbox" id="autoDelete" style="width: 18px; height: 18px; cursor: pointer;">
                <label for="autoDelete" style="color: var(--text-secondary); font-size: 0.9rem; cursor: pointer;">
                    Eliminar video original al finalizar
                </label>
            </div>

            <!-- Upload Progress -->
            <div id="uploadProgress" class="hidden" style="margin-top: 25px;">
                <div
                    style="display: flex; justify-content: space-between; margin-bottom: 10px; font-family: 'JetBrains Mono'; font-size: 0.9rem;">
                    <span style="color: var(--accent-cyan); text-shadow: 0 0 10px rgba(0, 243, 255, 0.5);">>>
                        SUBIENDO ARCHIVO...</span>
                    <span id="uploadPercent" style="color: var(--text-primary); font-weight: bold;">0%</span>
                </div>
                <div
                    style="width: 100%; height: 8px; background: rgba(255, 255, 255, 0.05); border-radius: 4px; overflow: hidden; border: 1px solid rgba(255, 255, 255, 0.1);">
                    <div id="uploadBar"
                        style="width: 0%; height: 100%; background: linear-gradient(90deg, var(--accent-cyan), var(--accent-purple)); border-radius: 4px; box-shadow: 0 0 15px rgba(0, 243, 255, 0.5); transition: width 0.1s linear;">
                    </div>
                </div>
            </div>

            <!-- Manual Start Button -->
            <button id="btnStartProcess" class="hidden" onclick="startProcessing()"
                style="margin-top: 25px; background: linear-gradient(90deg, var(--success), #00a8ff); color: #000; animation: pulse 2s infinite; font-size: 1.1rem; letter-spacing: 2px;">
                ‚ñ∂ INICIAR PROCESAMIENTO
            </button>

            <button id="processButton" style="margin-top: 20px;" disabled class="hidden">INICIAR PROCESO</button>
        </div>

        <!-- Processing Section -->
        <div class="card hidden" id="processingCard">
            <div class="steps-container">
                <div class="progress-track"></div>
                <div class="progress-fill" id="progressFill"></div>
                <div class="step" id="step1">1 <span class="step-label">Preparando</span></div>
                <div class="step" id="step2">2 <span class="step-label">Transcribiendo</span></div>
                <div class="step" id="step3">3 <span class="step-label">Finalizando</span></div>
            </div>

            <div class="status-panel">
                <div class="timer" id="timerDisplay">00:00</div>
                <div class="status-text pulsing" id="statusMessage">>> ESPERANDO ARCHIVO...</div>
            </div>
        </div>

        <!-- Result Section -->
        <div id="resultSection" class="card hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h3 style="color: var(--success); font-family: 'JetBrains Mono'; margin: 0;">/// TRANSCRIPCI√ìN
                    COMPLETADA
                </h3>
                <button
                    onclick="downloadText('transcripcion.txt', document.getElementById('transcriptionResult').value)"
                    style="background: #333; color: var(--text-primary); padding: 5px 15px; font-size: 0.8rem; width: auto; margin: 0; border: 1px solid #555;">
                    ‚¨á EXPORTAR TXT
                </button>
            </div>
            <textarea id="transcriptionResult" readonly></textarea>

            <div class="ai-section">
                <div class="ai-header">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 18a8 8 0 1 1 8-8 8 8 0 0 1-8 8z"></path>
                        <path d="M12 6v6l4 2"></path>
                    </svg>
                    <h3>ESTUDIANTE IA - COPILOT</h3>
                </div>
                
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button onclick="generateStudyGuide()" id="btnStudyGuide"
                        style="background: linear-gradient(45deg, #00d2ff, #3a7bd5); color: white; flex: 1;">
                        ‚ú® GENERAR GU√çA DE ESTUDIO
                    </button>
                    <button onclick="exportToNotebookLM()" id="btnExportMD"
                        style="background: linear-gradient(45deg, #2ecc71, #27ae60); color: white; flex: 1;">
                        üìì EXPORTAR PARA NOTEBOOKLM
                    </button>
                </div>

                <div style="position: relative;">
                    <textarea id="aiPrompt"
                        placeholder="Haz una pregunta sobre la clase o pide algo espec√≠fico (ej: 'Explica el t√©rmino X')..."
                        rows="3" style="margin-bottom: 10px;"></textarea>
                    <button onclick="generateCustomAnalysis()" id="btnSummary"
                        style="background: linear-gradient(45deg, var(--accent-purple), #ff0055); color: white;">ENVIAR PREGUNTA</button>
                </div>

                <div id="summaryResultContainer" class="hidden">
                    <div id="summaryResult" class="ai-result markdown-body"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const processButton = document.getElementById('processButton');
        const uploadCard = document.getElementById('uploadCard');
        const processingCard = document.getElementById('processingCard');
        const timerDisplay = document.getElementById('timerDisplay');
        const statusMessage = document.getElementById('statusMessage');
        const transcriptionModeSelect = document.getElementById('transcriptionMode');

        let selectedFile = null;
        let currentJobId = null;
        let timerInterval;
        let seconds = 0;
        let pollInterval;

        // Drag & Drop functionality
        dropZone.addEventListener('click', () => fileInput.click());

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileSelection(e.target.files[0]);
            }
        });

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-over');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');

            if (e.dataTransfer.files.length > 0) {
                handleFileSelection(e.dataTransfer.files[0]);
            }
        });

        function handleFileSelection(file) {
            if (file && file.type === 'video/mp4') {
                selectedFile = file;
                dropZone.querySelector('h3').innerText = selectedFile.name;
                dropZone.querySelector('p').innerText = 'Listo para subir';

                // Auto-upload immediately as per new flow
                uploadFile(selectedFile);
            } else {
                alert('Por favor, seleccione un archivo MP4 v√°lido.');
            }
        }

        function uploadFile(file) {
            // UI Updates
            document.getElementById('uploadProgress').classList.remove('hidden');
            processButton.classList.add('hidden'); // Hide start button during upload
            dropZone.style.pointerEvents = 'none';
            dropZone.style.opacity = '0.5';

            const formData = new FormData();
            formData.append('file', file);
            formData.append('transcription_mode', transcriptionModeSelect.value);
            formData.append('summary_model', document.getElementById('summaryModel').value);

            const xhr = new XMLHttpRequest();
            xhr.open('POST', '/upload', true);

            xhr.upload.onprogress = (e) => {
                if (e.lengthComputable) {
                    const percentComplete = (e.loaded / e.total) * 100;
                    document.getElementById('uploadBar').style.width = percentComplete + '%';
                    document.getElementById('uploadPercent').innerText = Math.floor(percentComplete) + '%';
                }
            };

            xhr.onload = function () {
                if (xhr.status === 200) {
                    const data = JSON.parse(xhr.responseText);
                    currentJobId = data.job_id;

                    // Show Start Button instead of auto-switching
                    document.getElementById('uploadPercent').innerText = "100% - LISTO";
                    document.getElementById('uploadPercent').style.color = "var(--success)";
                    document.getElementById('uploadBar').style.background = "var(--success)";
                    document.getElementById('uploadBar').style.boxShadow = "0 0 20px var(--success)";

                    document.getElementById('btnStartProcess').classList.remove('hidden');
                } else {
                    alert("Error al iniciar el procesamiento");
                    resetUploadUI();
                }
            };

            xhr.onerror = function () {
                alert("Error de conexi√≥n al subir archivo.");
                resetUploadUI();
            };

            xhr.send(formData);
        }

        function resetUploadUI() {
            document.getElementById('uploadProgress').classList.add('hidden');
            processButton.classList.remove('hidden');
            dropZone.style.pointerEvents = 'auto';
            dropZone.style.opacity = '1';
            document.getElementById('uploadBar').style.width = '0%';
            document.getElementById('btnStartProcess').classList.add('hidden');
            selectedFile = null;
            dropZone.querySelector('h3').innerText = 'ARRASTRAR ARCHIVO MP4 AQU√ç';
            dropZone.querySelector('p').innerText = 'o haga clic para seleccionar';
        }

        function startProcessing() {
            if (!currentJobId) return;

            // Switch UI
            uploadCard.classList.add('hidden');
            processingCard.classList.remove('hidden');
            startTimer();

            // Get Auto Delete preference
            const autoDelete = document.getElementById('autoDelete').checked;
            const formData = new FormData();
            formData.append('auto_delete', autoDelete);

            // Call API to start
            fetch(`/start_process/${currentJobId}`, {
                method: 'POST',
                body: formData
            })
                .then(res => res.json())
                .then(data => {
                    console.log("Proceso iniciado:", data);
                    // Start Polling
                    pollInterval = setInterval(pollStatus, 1000);
                })
                .catch(err => {
                    alert("Error iniciando proceso: " + err);
                    location.reload();
                });
        }

        function startTimer() {
            seconds = 0;
            timerDisplay.innerText = '00:00';

            timerInterval = setInterval(() => {
                seconds++;
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                timerDisplay.innerText =
                    `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        async function pollStatus() {
            try {
                const res = await fetch(`/status/${currentJobId}`);
                const data = await res.json();

                // Update Status Text
                if (data.stage === 'preparing') {
                    updateSteps(1);
                    statusMessage.innerText = ">> PREPARANDO AUDIO...";
                } else if (data.stage.startsWith('transcribing')) {
                    updateSteps(2);
                    statusMessage.innerText = `>> TRANSCRIBIENDO CHUNK ${data.current_chunk}/${data.total_chunks}...`;
                } else if (data.stage === 'finished') {
                    updateSteps(3);
                    statusMessage.innerText = ">> FINALIZADO";
                    finishJob(data.result);
                } else if (data.status === 'failed') {
                    clearInterval(pollInterval);
                    clearInterval(timerInterval);
                    alert("Error en el proceso: " + data.error);
                    location.reload();
                }

            } catch (e) {
                console.error("Error polling:", e);
            }
        }

        function updateSteps(stepNumber) {
            const fill = document.getElementById('progressFill');
            let width = '0%';

            if (stepNumber === 1) width = '15%';
            if (stepNumber === 2) width = '50%';
            if (stepNumber === 3) width = '100%';

            fill.style.width = width;

            document.querySelectorAll('.step').forEach((el, index) => {
                if (index + 1 < stepNumber) {
                    el.classList.add('completed');
                    el.classList.remove('active');
                } else if (index + 1 === stepNumber) {
                    el.classList.add('active');
                    el.classList.remove('completed');
                } else {
                    el.classList.remove('active', 'completed');
                }
            });
        }

        function finishJob(text) {
            clearInterval(pollInterval);
            clearInterval(timerInterval);

            processingCard.classList.add('hidden');
            document.getElementById('resultSection').classList.remove('hidden');
            document.getElementById('transcriptionResult').value = text;
        }

        async function generateStudyGuide() {
            const btn = document.getElementById('btnStudyGuide');
            btn.disabled = true;
            btn.innerText = "GENERANDO GU√çA...";
            
            await callAnalyze(""); // Empty prompt triggers study guide
            
            btn.disabled = false;
            btn.innerText = "‚ú® GENERAR GU√çA DE ESTUDIO";
        }

        async function generateCustomAnalysis() {
            const prompt = document.getElementById('aiPrompt').value;
            if (!prompt) {
                alert("Por favor ingrese una pregunta o instrucci√≥n");
                return;
            }
            
            const btn = document.getElementById('btnSummary');
            btn.disabled = true;
            btn.innerText = "PROCESANDO...";
            
            await callAnalyze(prompt);
            
            btn.disabled = false;
            btn.innerText = "ENVIAR PREGUNTA";
        }

        async function callAnalyze(prompt) {
            const text = document.getElementById('transcriptionResult').value;
            const model = document.getElementById('summaryModel').value;
            const container = document.getElementById('summaryResultContainer');
            const resultDiv = document.getElementById('summaryResult');

            try {
                const response = await fetch('/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: text,
                        prompt: prompt,
                        model: model,
                        job_id: currentJobId
                    })
                });

                const data = await response.json();
                container.classList.remove('hidden');
                // Simple markdown-to-html conversion for the presentation
                let formatted = data.analysis
                    .replace(/### (.*)/g, '<h3>$1</h3>')
                    .replace(/## (.*)/g, '<h2>$1</h2>')
                    .replace(/\*\* (.*)\*\*/g, '<strong>$1</strong>')
                    .replace(/\n\n/g, '<p></p>')
                    .replace(/\n/g, '<br>');
                
                resultDiv.innerHTML = formatted;
                resultDiv.scrollIntoView({ behavior: 'smooth' });
            } catch (e) {
                alert("Error en el an√°lisis: " + e);
            }
        }

        async function exportToNotebookLM() {
            if (!currentJobId) {
                alert("Primero debes procesar un video");
                return;
            }
            
            const btn = document.getElementById('btnExportMD');
            btn.disabled = true;
            btn.innerText = "PREPARANDO EXPORTACI√ìN...";

            try {
                const response = await fetch('/export', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        job_id: currentJobId,
                        include_analysis: true
                    })
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `clase_notebooklm_${currentJobId}.md`;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                } else {
                    alert("Error exportando archivo");
                }
            } catch (e) {
                alert("Error de conexi√≥n: " + e);
            } finally {
                btn.disabled = false;
                btn.innerText = "üìì EXPORTAR PARA NOTEBOOKLM";
            }
        }

        function downloadText(filename, text) {
            const element = document.createElement('a');
            element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
            element.setAttribute('download', filename);

            element.style.display = 'none';
            document.body.appendChild(element);

            element.click();

            document.body.removeChild(element);
        }
    </script>
</body>

</html>